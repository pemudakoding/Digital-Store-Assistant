<!-- Generated by SpecStory -->

# Masalah kecepatan eksekusi command (2025-06-28 01:41:34)

_**User**_

saat command dijalankan dengan cepat seperti saya mengirim command yang sama sebanyak dua kali dengan waktu yang bersama queue akan delay dan akan slow detected dan akhirnya timeout

---

_**Assistant**_



---

Saya akan menganalisis masalah performa queue yang Anda alami ketika command dikirim berulang dengan cepat. Mari saya periksa implementasi sistem queue dan command handling terlebih dahulu.

---

Read file: src/utils/queue.js

---

Read file: src/handlers/CommandHandler.js

---

Read file: src/handlers/MessageHandler.js

---

Sekarang saya akan melihat bagian yang lebih spesifik tentang sistem queue dan timeout detection:

---

Read file: src/utils/queue.js

---

<details>
            <summary>Grep search for "throttle|rate.*limit|cooldown|debounce" • **23** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///d%3A/projects/KoalaStore/src/services/MessageService.js` | L23 | `// Check rate limiting` |
| `file:///d%3A/projects/KoalaStore/src/services/MessageService.js` | L24 | `if (!this.checkRateLimit(to)) {` |
| `file:///d%3A/projects/KoalaStore/src/services/MessageService.js` | L25 | `logger.warn(`Rate limiting messages to ${to}`);` |
| `file:///d%3A/projects/KoalaStore/src/services/MessageService.js` | L61 | `* Check rate limiting for a specific chat` |
| `file:///d%3A/projects/KoalaStore/src/services/MessageService.js` | L63 | `checkRateLimit(chatId, minInterval = 1000) {` |
| `file:///d%3A/projects/KoalaStore/src/services/MessageService.js` | L452 | `* Clear rate limiting cache` |
| `file:///d%3A/projects/KoalaStore/src/services/MessageService.js` | L454 | `clearRateLimit() {` |
| `file:///d%3A/projects/KoalaStore/src/services/MessageService.js` | L456 | `logger.info('Rate limit cache cleared');` |
| `file:///d%3A/projects/KoalaStore/src/handlers/MessageHandler.js` | L51 | `logger.debug(`Rate limiting user ${userId}`);` |
| `file:///d%3A/projects/KoalaStore/src/handlers/CommandHandler.js` | L275 | `} else if (error.message?.includes('rate limit')) {` |
| `file:///d%3A/projects/KoalaStore/src/commands/owner/resetqueue.js` | L31 | `// Clear message service rate limiting` |
| `file:///d%3A/projects/KoalaStore/src/commands/owner/resetqueue.js` | L32 | `if (services.messageService.clearRateLimit) {` |
| `file:///d%3A/projects/KoalaStore/src/commands/owner/resetqueue.js` | L33 | `services.messageService.clearRateLimit();` |
| `file:///d%3A/projects/KoalaStore/src/commands/owner/resetqueue.js` | L63 | `• ✅ Rate limits reset` |
| `file:///d%3A/projects/KoalaStore/README.md` | L52 | `- **Anti-Spam Protection** - Rate limiting dan queue management` |
| `file:///d%3A/projects/KoalaStore/README.md` | L78 | `| **Queue** | p-queue | Rate limiting & race condition prevention |` |
| `file:///d%3A/projects/KoalaStore/.specstory/guides/bot-responsiveness-improvements.md` | L14 | `4. **Tidak Ada Rate Limiting** - Bot bisa overload dari spam requests` |
| `file:///d%3A/projects/KoalaStore/.specstory/guides/bot-responsiveness-improvements.md` | L46 | `#### Rate Limiting` |
| `file:///d%3A/projects/KoalaStore/.specstory/guides/bot-responsiveness-improvements.md` | L50 | `logger.debug(`Rate limiting user ${userId}`);` |
| `file:///d%3A/projects/KoalaStore/.specstory/guides/bot-responsiveness-improvements.md` | L92 | `- Timeout, rate limit, permission-specific messages` |
| `file:///d%3A/projects/KoalaStore/.specstory/guides/bot-responsiveness-improvements.md` | L112 | `- Rate limiting per chat to prevent spam` |
| `file:///d%3A/projects/KoalaStore/.specstory/guides/bot-responsiveness-improvements.md` | L156 | `- Reset rate limiting caches` |
| `file:///d%3A/projects/KoalaStore/.specstory/guides/bot-responsiveness-improvements.md` | L164 | `3. Reset rate limiting` |
| `file:///d%3A/projects/KoalaStore/.specstory/guides/bot-responsiveness-improvements.md` | L178 | `1. **Prevention:** Input validation, rate limiting, context checking` |
| `file:///d%3A/projects/KoalaStore/.specstory/guides/bot-responsiveness-improvements.md` | L185 | `- Rate limiting cache with TTL` |
| `file:///d%3A/projects/KoalaStore/.docs/README.md` | L36 | `- **Rate Limiting** - Per-user message processing dengan 1 second cooldown` |
| `file:///d%3A/projects/KoalaStore/.docs/README.md` | L104 | `- **Auto-Response System** - Respons otomatis berdasarkan context dengan rate limiting` |
| `file:///d%3A/projects/KoalaStore/.docs/README.md` | L115 | `- **Message Queue System** - Rate limiting dan spam protection dengan health monitoring` |
| `file:///d%3A/projects/KoalaStore/.docs/README.md` | L153 | `| **Queue** | p-queue | 8.0.1+ | Message rate limiting & race condition prevention |` |
| `file:///d%3A/projects/KoalaStore/.docs/README.md` | L172 | `- Broadcast announcements dengan queue management dan rate limiting` |
| `file:///d%3A/projects/KoalaStore/.docs/21-monitoring-and-health.md` | L64 | `- **Rate Limit Reset** - Reset semua rate limiting counters` |
| `file:///d%3A/projects/KoalaStore/.docs/19-faq.md` | L24 | `**A:** Risk ada tapi minimal jika digunakan dengan wajar. Hindari spam dan ikuti rate limiting. Gunakan nomor terpisah untuk bot jika khawatir.` |
| `file:///d%3A/projects/KoalaStore/.docs/19-faq.md` | L58 | `**A:** Bot memiliki permission system, rate limiting, dan anti-spam protection. Admin dapat kick user yang abuse.` |
| `file:///d%3A/projects/KoalaStore/.docs/18-troubleshooting.md` | L383 | `| `428` | Connection rate limited | Wait before reconnecting |` |
| `file:///d%3A/projects/KoalaStore/.docs/16-deployment.md` | L105 | `RATE_LIMIT_ENABLED=true` |
| `file:///d%3A/projects/KoalaStore/.docs/10-store-management.md` | L462 | `- **Rate limiting** - Prevent spam orders` |
| `file:///d%3A/projects/KoalaStore/.docs/08-image-support.md` | L220 | `3. **Rate Limiting**: Be mindful of upload service limits` |
| `file:///d%3A/projects/KoalaStore/.docs/05-architecture.md` | L98 | `- Apply middleware (auth, rate limiting)` |
| `file:///d%3A/projects/KoalaStore/.docs/05-architecture.md` | L205 | `4. Apply Middleware (auth, rate limiting)` |
| `file:///d%3A/projects/KoalaStore/.docs/05-architecture.md` | L378 | `### Rate Limiting` |
| `file:///d%3A/projects/KoalaStore/.docs/05-architecture.md` | L381 | `// Built-in rate limiting` |
| `file:///d%3A/projects/KoalaStore/.docs/05-architecture.md` | L382 | `const rateLimiter = new Map();` |
| `file:///d%3A/projects/KoalaStore/.docs/05-architecture.md` | L384 | `function checkRateLimit(userId, command) {` |
| `file:///d%3A/projects/KoalaStore/.docs/05-architecture.md` | L386 | `const lastUsed = rateLimiter.get(key);` |
| `file:///d%3A/projects/KoalaStore/.docs/05-architecture.md` | L390 | `throw new Error('Rate limited');` |
| `file:///d%3A/projects/KoalaStore/.docs/05-architecture.md` | L393 | `rateLimiter.set(key, now);` |
| `file:///d%3A/projects/KoalaStore/.docs/04-project-structure.md` | L105 | `- Middleware support (auth, validation, rate limiting)` |
| `file:///d%3A/projects/KoalaStore/.docs/04-project-structure.md` | L178 | `- External API rate limiting` |
| `file:///d%3A/projects/KoalaStore/.docs/04-project-structure.md` | L186 | `├── queue.js                   # Message queue dan rate limiting` |
| `file:///d%3A/projects/KoalaStore/.docs/04-project-structure.md` | L198 | `- **queue.js**: Rate limiting, spam protection, message ordering` |
| `file:///d%3A/projects/KoalaStore/.docs/04-project-structure.md` | L228 | `- Rate limiting per user` |
| `file:///d%3A/projects/KoalaStore/.docs/03-configuration.md` | L121 | `RATE_LIMIT_PER_MINUTE=30` |
| `file:///d%3A/projects/KoalaStore/.docs/03-configuration.md` | L218 | `rateLimiting: true,` |
| `file:///d%3A/projects/KoalaStore/.docs/03-configuration.md` | L226 | `rateLimit: 30,                         // per minute` |
| `file:///d%3A/projects/KoalaStore/.docs/03-configuration.md` | L228 | `commandCooldown: 2000                  // 2 seconds` |
| `file:///d%3A/projects/KoalaStore/.docs/03-configuration.md` | L305 | `// Rate Limiting` |
| `file:///d%3A/projects/KoalaStore/.docs/03-configuration.md` | L306 | `rateLimit: {` |
| `file:///d%3A/projects/KoalaStore/.docs/03-configuration.md` | L333 | `cooldownDuration: 2000,   // 2 detik antar command` |
| `file:///d%3A/projects/KoalaStore/.docs/03-configuration.md` | L371 | `rateLimitHit: "⏰ Silakan tunggu sebelum menggunakan command lagi"` |
| `file:///d%3A/projects/KoalaStore/.docs/03-configuration.md` | L544 | `- Enable rate limiting` |
| `file:///d%3A/projects/KoalaStore/.cursor/rules/02-whatsapp-bot-domain-knowledge.mdc` | L243 | `### Rate Limiting Strategies` |
| `file:///d%3A/projects/KoalaStore/.cursor/rules/02-whatsapp-bot-domain-knowledge.mdc` | L245 | `// Per-user rate limiting (1 message per second)` |
| `file:///d%3A/projects/KoalaStore/.cursor/rules/02-whatsapp-bot-domain-knowledge.mdc` | L441 | `### ❌ Ignoring Rate Limits` |
| `file:///d%3A/projects/KoalaStore/.cursor/rules/01-basic-standards.mdc` | L76 | `- Handle WhatsApp-specific errors (connection, rate limits)` |
| `file:///d%3A/projects/KoalaStore/.cursor/rules/01-basic-standards.mdc` | L82 | `- Rate limiting for command usage` |
| `file:///d%3A/projects/KoalaStore/.cursor/rules/01-basic-standards.mdc` | L130 | `- Implement rate limiting per user` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-26_07-31-saran-organisasi-file-yang-terstruktur.md` | L49 | `│   │       └── rateLimit.js` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-26_07-31-saran-organisasi-file-yang-terstruktur.md` | L103 | `- `middleware/`: Middleware untuk authentication, rate limiting, dll` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-26_07-31-saran-organisasi-file-yang-terstruktur.md` | L199 | `+ │   └── middleware/        # Bot middleware (auth, rateLimit)` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-26_08-23-refactor-legacy-bot-store-project.md` | L4275 | `'debouncedTimeout',` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-26_08-23-refactor-legacy-bot-store-project.md` | L8796 | `+  * Manages concurrent message handling with rate limiting` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-26_08-23-refactor-legacy-bot-store-project.md` | L10812 | `+ - **Queue System**: Better concurrency control and rate limiting` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-26_08-23-refactor-legacy-bot-store-project.md` | L11413 | `+ | `queue.js` | `utils/queue.js` | ✅ Enhanced with rate limiting |` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-26_08-23-refactor-legacy-bot-store-project.md` | L11490 | `+ - ✅ Rate limiting` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-26_08-23-refactor-legacy-bot-store-project.md` | L11891 | `7. **🚀 Performance Improvements** - Enhanced queue system dengan rate limiting` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-26_08-23-refactor-legacy-bot-store-project.md` | L25655 | `⏱️  Debounce delay: 1500ms` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-26_08-23-refactor-legacy-bot-store-project.md` | L26168 | `+ - Handle WhatsApp-specific errors (connection, rate limits)` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-26_08-23-refactor-legacy-bot-store-project.md` | L26174 | `+ - Rate limiting for command usage` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-26_08-23-refactor-legacy-bot-store-project.md` | L26222 | `+ - Implement rate limiting per user` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-26_09-23-analisa-dan-dokumentasi-command-bot.md` | L159 | `- Queue system for rate limiting` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-26_18-11-dokumentasi-proyek-untuk-onboarding-dan-kolaborasi.md` | L940 | `+ ### Rate Limiting` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-26_18-11-dokumentasi-proyek-untuk-onboarding-dan-kolaborasi.md` | L943 | `+ const rateLimits = {` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-26_18-11-dokumentasi-proyek-untuk-onboarding-dan-kolaborasi.md` | L1135 | `+   rateLimiting: true,` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-26_18-11-dokumentasi-proyek-untuk-onboarding-dan-kolaborasi.md` | L3520 | `+ - **Rate Limiting** - Anti-spam protection` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-26_18-11-dokumentasi-proyek-untuk-onboarding-dan-kolaborasi.md` | L3528 | `+ - **Rate Limiting** - Protection against spam/abuse` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-26_18-11-dokumentasi-proyek-untuk-onboarding-dan-kolaborasi.md` | L4180 | `+ - **Rate limiting** - Prevent spam orders` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-26_18-11-dokumentasi-proyek-untuk-onboarding-dan-kolaborasi.md` | L4622 | `+ | `428` | Connection rate limited | Wait before reconnecting |` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-26_18-11-dokumentasi-proyek-untuk-onboarding-dan-kolaborasi.md` | L4839 | `+ **A:** Risk ada tapi minimal jika digunakan dengan wajar. Hindari spam dan ikuti rate limiting. Gunakan nomor terpisah untuk bot jika khawatir.` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-26_18-11-dokumentasi-proyek-untuk-onboarding-dan-kolaborasi.md` | L4873 | `+ **A:** Bot memiliki permission system, rate limiting, dan anti-spam protection. Admin dapat kick user yang abuse.` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-26_18-11-dokumentasi-proyek-untuk-onboarding-dan-kolaborasi.md` | L5444 | `+ - Apply middleware (auth, rate limiting)` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-26_18-11-dokumentasi-proyek-untuk-onboarding-dan-kolaborasi.md` | L5551 | `+ 4. Apply Middleware (auth, rate limiting)` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-26_18-11-dokumentasi-proyek-untuk-onboarding-dan-kolaborasi.md` | L5724 | `+ ### Rate Limiting` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-26_18-11-dokumentasi-proyek-untuk-onboarding-dan-kolaborasi.md` | L5727 | `+ // Built-in rate limiting` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-26_18-11-dokumentasi-proyek-untuk-onboarding-dan-kolaborasi.md` | L5728 | `+ const rateLimiter = new Map();` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-26_18-11-dokumentasi-proyek-untuk-onboarding-dan-kolaborasi.md` | L5730 | `+ function checkRateLimit(userId, command) {` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-26_18-11-dokumentasi-proyek-untuk-onboarding-dan-kolaborasi.md` | L5732 | `+     const lastUsed = rateLimiter.get(key);` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-26_18-11-dokumentasi-proyek-untuk-onboarding-dan-kolaborasi.md` | L5736 | `+         throw new Error('Rate limited');` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-26_18-11-dokumentasi-proyek-untuk-onboarding-dan-kolaborasi.md` | L5739 | `+     rateLimiter.set(key, now);` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-26_18-11-dokumentasi-proyek-untuk-onboarding-dan-kolaborasi.md` | L8939 | `- ✅ **Rapid disconnection protection** (5-second cooldown)` |
| `file:///d%3A/projects/KoalaStore/src/services/MessageService.js` | L23 | `// Check rate limiting` |
| `file:///d%3A/projects/KoalaStore/src/services/MessageService.js` | L24 | `if (!this.checkRateLimit(to)) {` |
| `file:///d%3A/projects/KoalaStore/src/services/MessageService.js` | L25 | `logger.warn(`Rate limiting messages to ${to}`);` |
| `file:///d%3A/projects/KoalaStore/src/services/MessageService.js` | L61 | `* Check rate limiting for a specific chat` |
| `file:///d%3A/projects/KoalaStore/src/services/MessageService.js` | L63 | `checkRateLimit(chatId, minInterval = 1000) {` |
| `file:///d%3A/projects/KoalaStore/src/services/MessageService.js` | L452 | `* Clear rate limiting cache` |
| `file:///d%3A/projects/KoalaStore/src/services/MessageService.js` | L454 | `clearRateLimit() {` |
| `file:///d%3A/projects/KoalaStore/src/services/MessageService.js` | L456 | `logger.info('Rate limit cache cleared');` |

</details>

---

Sekarang saya akan melihat implementasi rate limiting yang ada dan bagaimana ia berinteraksi dengan sistem queue:

---

Read file: src/services/MessageService.js

---

<details>
            <summary>Grep search for "lastProcessedTime" • **3** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///d%3A/projects/KoalaStore/src/handlers/MessageHandler.js` | L9 | `this.lastProcessedTime = new Map(); // Track last processed time per user to prevent spam` |
| `file:///d%3A/projects/KoalaStore/src/handlers/MessageHandler.js` | L48 | `const lastProcessed = this.lastProcessedTime.get(userId) || 0;` |
| `file:///d%3A/projects/KoalaStore/src/handlers/MessageHandler.js` | L55 | `this.lastProcessedTime.set(userId, now);` |
| `file:///d%3A/projects/KoalaStore/.cursor/rules/02-whatsapp-bot-domain-knowledge.mdc` | L247 | `const lastProcessed = lastProcessedTime.get(userId) || 0;` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-27_15-03-tingkatkan-responsivitas-bot.md` | L326 | `+         this.lastProcessedTime = new Map(); // Track last processed time per user to prevent spam` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-27_15-03-tingkatkan-responsivitas-bot.md` | L361 | `+             const lastProcessed = this.lastProcessedTime.get(userId) || 0;` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-27_15-03-tingkatkan-responsivitas-bot.md` | L368 | `+             this.lastProcessedTime.set(userId, now);` |
| `file:///d%3A/projects/KoalaStore/.specstory/history/2025-06-27_15-03-tingkatkan-responsivitas-bot.md` | L7194 | `+ const lastProcessed = lastProcessedTime.get(userId) || 0;` |

</details>

---

Sekarang saya akan menganalisis masalah dan membuat solusi yang tepat. Berdasarkan analisis kode, saya menemukan beberapa masalah:

1. **Rate limiting terlalu agresif**: 1 detik per user untuk semua message
2. **Queue timeout yang tidak optimal**: Command timeout 20 detik, tapi queue timeout 35 detik 
3. **Tidak ada deduplication untuk command berulang**
4. **Tidak ada command-specific rate limiting**

Mari saya buat solusi yang komprehensif:

---

```diff
          this.commandHandler = commandHandler;
          this.lastProcessedTime = new Map(); // Track last processed time per user to prevent spam
+         
+         // Enhanced rate limiting and deduplication
+         this.commandCooldowns = new Map(); // Command-specific cooldowns
+         this.commandDeduplication = new Map(); // Prevent duplicate commands
+         this.userCommandHistory = new Map(); // Track user command history
+         
+         // Rate limiting configurations
+         this.rateLimitConfig = {
+             globalMessage: 500,     // Reduced from 1000ms to 500ms for better responsiveness
+             commandCooldown: 1500,  // Default command cooldown 1.5 seconds
+             quickCommands: 800,     // Quick commands (ping, help) only 800ms
+             adminCommands: 2000,    // Admin commands need 2 seconds
+             ownerCommands: 1000,    // Owner commands need 1 second
+             storeCommands: 2500,    // Store operations need 2.5 seconds
+         };
+         
+         // Command categories for different rate limits
+         this.commandCategories = {
+             quick: ['ping', 'help', 'allmenu', 'owner'],
+             admin: ['hidetag', 'tagall', 'kick', 'promote', 'demote', 'group', 'antilink'],
+             owner: ['broadcast', 'block', 'unblock', 'join', 'mode', 'reloadcommands'],
+             store: ['addproduk', 'delproduk', 'addtesti', 'deltesti', 'addsewa', 'delsewa', 'list', 'produk']
+         };
+         
+         // Auto cleanup maps every 5 minutes
+         setInterval(() => {
+             this.cleanupMaps();
+         }, 300000);
+     }
+ 
+     /**
+      * Cleanup old entries from maps to prevent memory leaks
+      */
+     cleanupMaps() {
+         const now = Date.now();
+         const cleanupAge = 600000; // 10 minutes
+         
+         // Cleanup lastProcessedTime
+         for (const [key, time] of this.lastProcessedTime.entries()) {
+             if (now - time > cleanupAge) {
+                 this.lastProcessedTime.delete(key);
+             }
+         }
+         
+         // Cleanup commandCooldowns
+         for (const [key, time] of this.commandCooldowns.entries()) {
+             if (now - time > cleanupAge) {
+                 this.commandCooldowns.delete(key);
+             }
+         }
+         
+         // Cleanup commandDeduplication (shorter cleanup for recent duplicates)
+         for (const [key, time] of this.commandDeduplication.entries()) {
+             if (now - time > 30000) { // 30 seconds
+                 this.commandDeduplication.delete(key);
+             }
+         }
+         
+         // Cleanup userCommandHistory (keep last 50 commands per user)
+         for (const [userId, commands] of this.userCommandHistory.entries()) {
+             if (commands.length > 50) {
+                 this.userCommandHistory.set(userId, commands.slice(-50));
+             }
+         }
+         
+         logger.debug('Cleaned up rate limiting and deduplication maps');
+     }
+ 
+     /**
+      * Get command category for rate limiting
+      */
+     getCommandCategory(commandName) {
+         for (const [category, commands] of Object.entries(this.commandCategories)) {
+             if (commands.includes(commandName)) {
+                 return category;
+             }
+         }
+         return 'default';
+     }
+ 
+     /**
+      * Check if command should be rate limited
+      */
+     checkCommandRateLimit(userId, commandName) {
+         const now = Date.now();
+         const category = this.getCommandCategory(commandName);
+         
+         // Get appropriate cooldown time
+         let cooldownTime;
+         switch (category) {
+             case 'quick':
+                 cooldownTime = this.rateLimitConfig.quickCommands;
+                 break;
+             case 'admin':
+                 cooldownTime = this.rateLimitConfig.adminCommands;
+                 break;
+             case 'owner':
+                 cooldownTime = this.rateLimitConfig.ownerCommands;
+                 break;
+             case 'store':
+                 cooldownTime = this.rateLimitConfig.storeCommands;
+                 break;
+             default:
+                 cooldownTime = this.rateLimitConfig.commandCooldown;
+         }
+         
+         const cooldownKey = `${userId}:${commandName}`;
+         const lastUsed = this.commandCooldowns.get(cooldownKey) || 0;
+         
+         if (now - lastUsed < cooldownTime) {
+             const remainingTime = Math.ceil((cooldownTime - (now - lastUsed)) / 1000);
+             return { allowed: false, remainingTime, category };
+         }
+         
+         this.commandCooldowns.set(cooldownKey, now);
+         return { allowed: true, category };
+     }
+ 
+     /**
+      * Check for duplicate commands to prevent spam
+      */
+     checkCommandDeduplication(userId, commandName, args = []) {
+         const now = Date.now();
+         const commandSignature = `${userId}:${commandName}:${args.join(':')}`;
+         const lastExecuted = this.commandDeduplication.get(commandSignature) || 0;
+         
+         // Prevent same command with same args within 5 seconds
+         if (now - lastExecuted < 5000) {
+             return { isDuplicate: true, lastExecuted };
+         }
+         
+         this.commandDeduplication.set(commandSignature, now);
+         return { isDuplicate: false };
+     }
+ 
+     /**
+      * Track user command for analytics and abuse detection
+      */
+     trackUserCommand(userId, commandName) {
+         if (!this.userCommandHistory.has(userId)) {
+             this.userCommandHistory.set(userId, []);
+         }
+         
+         const userCommands = this.userCommandHistory.get(userId);
+         userCommands.push({
+             command: commandName,
+             timestamp: Date.now()
+         });
+         
+         // Keep only last 50 commands
+         if (userCommands.length > 50) {
+             userCommands.shift();
+         }
      }
  
```

```diff
              }
              
-             // Prevent spam processing (max 1 message per user per second)
+             // Enhanced rate limiting - reduced to 500ms for better responsiveness
              const userId = context.sender;
              const now = Date.now();
              const lastProcessed = this.lastProcessedTime.get(userId) || 0;
              
-             if (now - lastProcessed < 1000) {
-                 logger.debug(`Rate limiting user ${userId}`);
+             if (now - lastProcessed < this.rateLimitConfig.globalMessage) {
+                 logger.debug(`Global rate limiting user ${userId}`);
                  return;
              }
```

```diff
              const parsed = this.commandHandler.parseCommandWithoutPrefix(context.body);
              if (parsed) {
+                 // Command-specific rate limiting
+                 const rateLimitCheck = this.checkCommandRateLimit(userId, parsed.command);
+                 if (!rateLimitCheck.allowed) {
+                     logger.debug(`Command rate limited: ${parsed.command} for user ${userId}, remaining: ${rateLimitCheck.remainingTime}s`);
+                     
+                     // Send rate limit message only for non-quick commands to avoid spam
+                     if (rateLimitCheck.category !== 'quick') {
+                         await context.messageService.reply(
+                             context.from,
+                             `⏰ Tunggu ${rateLimitCheck.remainingTime} detik sebelum menggunakan command \`${parsed.command}\` lagi.`,
+                             context.msg
+                         );
+                     }
+                     return;
+                 }
+                 
+                 // Check for duplicate commands
+                 const deduplicationCheck = this.checkCommandDeduplication(userId, parsed.command, parsed.args);
+                 if (deduplicationCheck.isDuplicate) {
+                     logger.debug(`Duplicate command blocked: ${parsed.command} for user ${userId}`);
+                     
+                     // Silent return for duplicates - don't notify user to avoid spam
+                     return;
+                 }
+                 
+                 // Track command usage
+                 this.trackUserCommand(userId, parsed.command);
+                 
                  // Execute command using queue with enhanced error handling
                  await queueHelpers.safeAdd(
```

---

Sekarang saya akan mengoptimalkan sistem queue untuk mengatasi masalah timeout dan slow detection:

---

```diff
  const queueConfigs = {
      message: {
-         concurrency: 3,
-         interval: 1000,
-         intervalCap: 8,
-         timeout: 35000,        // Increased to 35s for better reliability
+         concurrency: 4,        // Increased from 3 to 4
+         interval: 800,         // Reduced from 1000ms to 800ms
+         intervalCap: 10,       // Increased from 8 to 10
+         timeout: 25000,        // Reduced from 35s to 25s for faster failure detection
          throwOnTimeout: false  // Changed to false for graceful handling
      },
      chatUpsert: {
-         concurrency: 5,
-         interval: 500,
-         intervalCap: 20,
-         timeout: 30000,        // Increased to 30s for better reliability
+         concurrency: 6,        // Increased from 5 to 6
+         interval: 400,         // Reduced from 500ms to 400ms
+         intervalCap: 25,       // Increased from 20 to 25
+         timeout: 20000,        // Reduced from 30s to 20s
          throwOnTimeout: false  // Changed to false for graceful handling
      },
      media: {
-         concurrency: 1,
-         interval: 2000,
-         intervalCap: 3,
-         timeout: 60000,        // Increased from 45s to 60s
+         concurrency: 2,        // Increased from 1 to 2
+         interval: 1500,        // Reduced from 2000ms to 1500ms
+         intervalCap: 4,        // Increased from 3 to 4
+         timeout: 45000,        // Reduced from 60s to 45s
          throwOnTimeout: false
      },
      group: {
-         concurrency: 2,
-         interval: 1500,
-         intervalCap: 4,
-         timeout: 20000,        // Increased from 15s to 20s
+         concurrency: 3,        // Increased from 2 to 3
+         interval: 1000,        // Reduced from 1500ms to 1000ms
+         intervalCap: 6,        // Increased from 4 to 6
+         timeout: 15000,        // Reduced from 20s to 15s
          throwOnTimeout: false
      },
      broadcast: {
-         concurrency: 1,
-         interval: 3000,
-         intervalCap: 1,
-         timeout: 45000,        // Increased from 30s to 45s
+         concurrency: 2,        // Increased from 1 to 2
+         interval: 2500,        // Reduced from 3000ms to 2500ms
+         intervalCap: 2,        // Increased from 1 to 2
+         timeout: 30000,        // Reduced from 45s to 30s
+         throwOnTimeout: false
+     },
+     // New priority queue for quick commands
+     priority: {
+         concurrency: 8,        // High concurrency for quick commands
+         interval: 200,         // Very low interval
+         intervalCap: 50,       // High cap
+         timeout: 8000,         // Short timeout for quick responses
          throwOnTimeout: false
      }
```

```diff
  const groupQueue = new PQueue(queueConfigs.group);
  const broadcastQueue = new PQueue(queueConfigs.broadcast);
+ const priorityQueue = new PQueue(queueConfigs.priority);  // New priority queue
  
  // Performance monitoring functions
```

```diff
      metrics.minDuration = Math.min(metrics.minDuration, duration);
      
-     // Track slow operations (>5 seconds)
-     if (duration > 5000) {
+     // Track slow operations (reduced threshold from 5s to 3s)
+     if (duration > 3000) {
          if (!performanceMetrics.slowOperations.has(key)) {
              performanceMetrics.slowOperations.set(key, []);
```

```diff
  
  // Enhanced error handling for all queues
- const queues = [messageQueue, chatUpsertQueue, mediaQueue, groupQueue, broadcastQueue];
- const queueNames = ['message', 'chatUpsert', 'media', 'group', 'broadcast'];
+ const queues = [messageQueue, chatUpsertQueue, mediaQueue, groupQueue, broadcastQueue, priorityQueue];
+ const queueNames = ['message', 'chatUpsert', 'media', 'group', 'broadcast', 'priority'];
  
  queues.forEach((queue, index) => {
```

```diff
      
      // Enhanced queue monitoring with adaptive warnings
+     const warningThreshold = queueName === 'message' ? 20 : 
+                            queueName === 'priority' ? 30 : 
+                            queueName === 'chatUpsert' ? 25 : 15;
      queue.on('add', () => {
-         const warningThreshold = queueName === 'message' ? 15 : 10;
          if (queue.size > warningThreshold) {
              logger.warn(`[${queueName}Queue] High queue size detected: ${queue.size}`);
          }
      });
      
-     // Enhanced queue stats monitoring
+     // Enhanced queue stats monitoring with faster intervals
      setInterval(() => {
          if (queue.size > 0 || queue.pending > 0) {
              logger.info(`[${queueName}Queue] Stats: Size=${queue.size}, Pending=${queue.pending}`);
          }
          
-         // Progressive queue clearing with warnings
-         const criticalThreshold = queueName === 'message' ? 100 : 50;
+         // Progressive queue clearing with warnings - adjusted thresholds
+         const criticalThreshold = queueName === 'message' ? 80 : 
+                                 queueName === 'priority' ? 100 :
+                                 queueName === 'chatUpsert' ? 70 : 50;
          if (queue.size > criticalThreshold) {
              logger.error(`[${queueName}Queue] Critical queue size (${queue.size}), clearing oldest tasks...`);
```

```diff
              logger.warn(`[${queueName}Queue] Cleared queue, keeping newest operations for stability`);
          }
-     }, 30000);
+     }, 20000); // Reduced from 30s to 20s for faster monitoring
  });
  
  // Utility function for queue status
  function getQueueStatus(queue, queueName) {
      if (queue.isPaused) return 'paused';
-     if (queue.size > 50) return 'critical';
-     if (queue.size > 20) return 'warning';
-     if (queue.size > 10) return 'busy';
+     
+     // Adjusted thresholds for better responsiveness
+     const criticalThreshold = queueName === 'priority' ? 80 : 
+                              queueName === 'message' ? 60 : 40;
+     const warningThreshold = queueName === 'priority' ? 50 : 
+                             queueName === 'message' ? 35 : 25;
+     const busyThreshold = queueName === 'priority' ? 25 : 
+                          queueName === 'message' ? 15 : 10;
+     
+     if (queue.size > criticalThreshold) return 'critical';
+     if (queue.size > warningThreshold) return 'warning';
+     if (queue.size > busyThreshold) return 'busy';
      return 'healthy';
  }
```

```diff
      groupQueue,
      broadcastQueue,
+     priorityQueue,
      queueHelpers,
      circuitBreaker
```

```diff
      groupQueue,
      broadcastQueue,
+     priorityQueue,
      queueHelpers,
      
```

```diff
              media: { size: mediaQueue.size, pending: mediaQueue.pending },
              group: { size: groupQueue.size, pending: groupQueue.pending },
-             broadcast: { size: broadcastQueue.size, pending: broadcastQueue.pending }
+             broadcast: { size: broadcastQueue.size, pending: broadcastQueue.pending },
+             priority: { size: priorityQueue.size, pending: priorityQueue.pending }
          };
      },
```

---

Sekarang saya akan menambahkan smart queue selection untuk command berdasarkan kategori:

---



---

Sekarang saya akan memperbarui MessageHandler untuk menggunakan smart queue selection:

---



---



---

Sekarang saya akan memperbaiki timeout handling di CommandHandler untuk mengurangi command timeout:

---



---

Mari saya baca CommandHandler untuk melihat konteks yang tepat:

---

Read file: src/handlers/CommandHandler.js

---



---

Sekarang saya akan memperbaiki timeout handling di CommandHandler dengan konteks yang tepat:

---



---



---

Sekarang saya akan menambahkan category ke context di MessageHandler:

---



---



---

Sekarang saya akan membuat command untuk monitoring sistem queue yang baru:

---

Cancelled

---



---

Mari saya baca file queuemonitor yang sudah ada terlebih dahulu:

---

Read file: src/commands/owner/queuemonitor.js

---



---

File queuemonitor sudah terbaru. Sekarang saya akan membuat command untuk menguji performa queue baru:

---

Cancelled

---

